{% extends 'base.html' %}

{% block title %}{{ produto.nome }} - Lumina Beauty{% endblock %}

{% block content %}

<style>
    .product-image-container {
        width: 100%;
        height: 500px; /* Altura fixa */
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: var(--white-color);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 8px 25px rgba(107, 73, 80, 0.12);
        position: relative;
        transition: all 1s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* EFEITO HOVER SUTIL NO CONTAINER */
    .product-image-container:hover {
        box-shadow: 0 12px 35px rgba(107, 73, 80, 0.2);
        transform: translateY(-6px);
    }

    /* IMAGEM DO PRODUTO - HOVER SUTIL */
    .product-image-container img.product-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: all 1s cubic-bezier(0.4, 0, 0.2, 1);
        max-width: 100%;
        max-height: 100%;
        background-color: var(--white-color);
        filter: brightness(0.98); /* Leve escurecimento inicial */
    }

    /* EFEITO HOVER SUTIL NA IMAGEM */
    .product-image-container:hover img.product-image {
        transform: scale(1.03); /* Zoom muito sutil */
        filter: brightness(1); /* Volta ao brilho normal */
    }

    /* Imagem padrão do blush - hover específico */
    .product-image-container img.default-image {
        object-fit: contain;
        padding: 20px;
        background-color: var(--secondary-color);
        transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        filter: brightness(0.98);
    }

    .product-image-container:hover img.default-image {
        transform: scale(1.02); /* Zoom mais suave para imagem padrão */
        filter: brightness(1);
    }

    /* EFEITO HOVER SUTIL NO PLACEHOLDER */
    .image-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #f9f0f2 0%, #f5e6e8 100%);
        color: var(--text-color);
        padding: 40px 20px;
        text-align: center;
        border: 2px dashed var(--primary-color);
        border-radius: 12px;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .product-image-container:hover .image-placeholder {
        background: linear-gradient(135deg, #f5e6e8 0%, #f1dce1 100%);
        border-color: var(--gold-color);
        transform: translateY(-4px);
    }

    /* Ícones com hover sutil */
    .image-placeholder i {
        font-size: 4rem;
        margin-bottom: 20px;
        color: var(--primary-color);
        opacity: 0.6;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .product-image-container:hover .image-placeholder i {
        transform: scale(1.05);
        opacity: 0.8;
    }

    .image-placeholder .product-icon {
        font-size: 4rem;
        margin-bottom: 20px;
        color: var(--gold-color);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .product-image-container:hover .image-placeholder .product-icon {
        transform: scale(1.05) rotate(5deg);
    }

    .image-placeholder p {
        font-size: 1.3rem;
        font-weight: 700;
        margin: 10px 0;
        color: var(--dark-accent);
        transition: all 0.3s ease;
    }

    .product-image-container:hover .image-placeholder p {
        color: var(--primary-color);
    }

    .image-placeholder small {
        font-size: 0.95rem;
        color: var(--text-color);
        opacity: 0.7;
        max-width: 80%;
        line-height: 1.4;
        transition: all 0.3s ease;
    }

    .product-image-container:hover .image-placeholder small {
        opacity: 0.9;
    }

    /* Ícones específicos por categoria - hover suave */
    .category-icon-labios { 
        color: #e63946 !important;
        transition: all 0.4s ease;
    }
    .product-image-container:hover .category-icon-labios {
        color: #ff4d6d !important;
    }
    
    .category-icon-rosto { 
        color: #ffb4a2 !important;
        transition: all 0.4s ease;
    }
    .product-image-container:hover .category-icon-rosto {
        color: #ffccd5 !important;
    }
    
    .category-icon-olhos { 
        color: #6d6875 !important;
        transition: all 0.4s ease;
    }
    .product-image-container:hover .category-icon-olhos {
        color: #9d8b9b !important;
    }
    
    .category-icon-skincare { 
        color: #a8dadc !important;
        transition: all 0.4s ease;
    }
    .product-image-container:hover .category-icon-skincare {
        color: #caf0f8 !important;
    }
    
    .category-icon-pinceis { 
        color: #b5838d !important;
        transition: all 0.4s ease;
    }
    .product-image-container:hover .category-icon-pinceis {
        color: #e5989b !important;
    }
    
    .category-icon-kits { 
        color: #ffd166 !important;
        transition: all 0.4s ease;
    }
    .product-image-container:hover .category-icon-kits {
        color: #ffde8a !important;
    }

    /* Overlay sutil no hover */
    .product-image-container::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
            to bottom,
            rgba(232, 184, 194, 0) 0%,
            rgba(232, 184, 194, 0.03) 100%
        );
        opacity: 0;
        transition: opacity 0.4s ease;
        pointer-events: none;
        border-radius: 12px;
    }

    .product-image-container:hover::after {
        opacity: 1;
    }

    /* Responsivo para mobile */
    @media (max-width: 768px) {
        .product-image-container {
            height: 350px;
            max-height: 60vh;
        }
        
        .image-placeholder i,
        .image-placeholder .product-icon {
            font-size: 2.5rem;
        }
        
        .image-placeholder p {
            font-size: 1.1rem;
        }
        
        .image-placeholder small {
            font-size: 0.85rem;
        }
        
        /* Hover mais sutil em mobile */
        .product-image-container:hover {
            transform: translateY(-2px);
        }
        
        .product-image-container:hover img.product-image {
            transform: scale(1.01);
        }
    }

    @media (max-width: 576px) {
        .product-image-container {
            height: 300px;
        }
    }
</style>

<!-- Mapeamento das categorias com acentos -->
{% set nomes_categorias = {
    'labios': 'Lábios',
    'rosto': 'Rosto',
    'olhos': 'Olhos',
    'skincare': 'Skincare',
    'pinceis': 'Pincéis',
    'kits': 'Kits'
} %}

<!-- Mapeamento de ícones por categoria -->
{% set categorias_icones = {
    'labios': 'bi-lips',
    'rosto': 'bi-palette',
    'olhos': 'bi-eye',
    'skincare': 'bi-droplet',
    'pinceis': 'bi-brush',
    'kits': 'bi-gift'
} %}

{% set categoria_nome = nomes_categorias.get(produto.categoria, produto.categoria|capitalize) %}
{% set categoria_icone = categorias_icones.get(produto.categoria, 'bi-box') %}

<!-- URL da imagem padrão (blush) -->
{% set default_image = 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQwDoSndS2IEwkdfPqUMW1AOmu9jPaW94WIbmR37Ffyf7TRnWCuRA94U9bM2eJViBxt3yc&usqp=CAU' %}

<div class="container py-5">
    <div class="row">
        <!-- Coluna da Imagem -->
        <div class="col-md-6 mb-4">
            <div class="product-image-container">
                {% if produto.imagem %}
                    <!-- Função para verificar se a imagem é válida -->
                    {% set is_valid_image = produto.imagem and 
                        produto.imagem|length > 10 and
                        'placeholder.com' not in produto.imagem and 
                        'placehold.co' not in produto.imagem and 
                        'https://placehold.co/' not in produto.imagem and
                        'Sem+Imagem' not in produto.imagem and
                        'sem_foto' not in produto.imagem|lower and
                        produto.imagem.startswith(('http://', 'https://')) %}
                    
                    {% if is_valid_image %}
                        <!-- Imagem real do produto com tratamento de erro -->
                        <img src="{{ produto.imagem }}" 
                             alt="{{ produto.nome }}" 
                             class="product-image"
                             id="product-main-image"
                             onerror="handleImageError(this)"
                             data-default="{{ default_image }}"
                             loading="lazy">
                    {% else %}
                        <!-- Usar imagem padrão do blush -->
                        <img src="{{ default_image }}" 
                             alt="{{ produto.nome }}" 
                             class="product-image default-image"
                             loading="lazy">
                    {% endif %}
                {% else %}
                    <!-- Placeholder elegante quando não há imagem -->
                    <div class="image-placeholder">
                        <i class="bi {{ categoria_icone }} product-icon category-icon-{{ produto.categoria }}"></i>
                        <p>{{ produto.nome }}</p>
                        <small>{{ categoria_nome }}</small>
                        <small class="mt-3"><i class="bi bi-info-circle me-1"></i> Visualização ilustrativa</small>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Coluna dos Detalhes -->
        <div class="col-md-6">
            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb" class="mb-3">
                <ol class="breadcrumb bg-transparent p-0">
                    <li class="breadcrumb-item">
                        <a href="{{ url_for('index') }}">Início</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="{{ url_for('categoria_produtos', nome_categoria=produto.categoria) }}">
                            {{ categoria_nome }}
                        </a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">
                        {{ produto.nome }}
                    </li>
                </ol>
            </nav>

            <!-- Título do Produto -->
            <h1 class="product-title">{{ produto.nome }}</h1>

            <!-- Preço -->
            <p class="product-price">R$ {{ "%.2f"|format(produto.preco)|replace('.', ',') }}</p>

            <!-- Descrição -->
            <p class="product-description">{{ produto.descricao }}</p>

            <!-- Formulário de Adicionar ao Carrinho -->
            {% if produto.estoque > 0 %}
            
            {% if user_info.logado and user_info.papel == 'cliente' %}
                <form method="POST" action="{{ url_for('adicionar_carrinho', id=produto.id) }}">
                    <div class="mb-4">
                        <label for="quantidade" class="quantity-label">Quantidade</label>
                        <div class="row g-2 align-items-center">
                            <div class="col-4">
                                <input type="number" id="quantidade" name="quantidade" class="form-control quantity-input" value="1" min="1" max="{{ produto.estoque }}" required>
                            </div>
                            <div class="col-8">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="bi bi-cart-plus me-2"></i> Adicionar ao Carrinho
                                </button>
                            </div>
                        </div>
                    </div>
                    <p class="stock-info text-muted small">
                        <i class="bi bi-box-seam"></i> Estoque disponível: <strong>{{ produto.estoque }} unidades</strong>
                    </p>
                </form>

            {% elif user_info.logado and user_info.papel == 'admin' %}
                <div class="alert alert-warning d-flex align-items-center shadow-sm">
                    <i class="bi bi-shield-lock-fill fs-3 me-3"></i>
                    <div>
                        <h6 class="alert-heading mb-1 fw-bold">Modo Administrador</h6>
                        <p class="mb-0 small">Estoque atual: {{ produto.estoque }}. <a href="{{ url_for('admin_produtos') }}">Gerenciar</a>.</p>
                    </div>
                </div>

            {% else %}
                <div class="alert alert-info shadow-sm">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Faça login para comprar.</strong>
                    <br>
                    <a href="{{ url_for('login') }}" class="alert-link">Entrar</a> ou <a href="{{ url_for('registrar_cliente') }}" class="alert-link">Criar conta</a>.
                </div>
            {% endif %}

            {% else %}
            
            <div class="alert alert-danger text-center p-4 shadow-sm">
                <i class="bi bi-x-circle fs-1 d-block mb-2"></i>
                <h4 class="alert-heading">Produto Esgotado</h4>

                {% if user_info.logado and user_info.papel == 'admin' %}
                    <p class="mb-3">O estoque deste item chegou a zero. Deseja realizar a reposição agora?</p>
                    <a href="{{ url_for('editar_produto', id=produto.id) }}" class="btn btn-danger fw-bold" style="transition: all .5s ease;">
                        <i class="bi bi-pencil-square me-2"></i> Repor Estoque
                    </a>
                {% else %}
                    <p>Desculpe, todas as unidades deste produto foram vendidas.</p>
                    <a href="{{ url_for('index') }}" class="btn btn-outline-danger mt-2">Ver outros produtos</a>
                {% endif %}
                
            </div>

            {% endif %}

            <!-- Informações Adicionais -->
            <div class="product-features mt-4">
                <h5 class="mb-3">Benefícios:</h5>
                <ul class="list-unstyled">
                    <li class="mb-2">
                        <i class="bi bi-check-circle-fill text-success me-2"></i>
                        Produto original e de alta qualidade
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-check-circle-fill text-success me-2"></i>
                        Frete grátis acima de R$ 250,00
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-check-circle-fill text-success me-2"></i>
                        Garantia de satisfação
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
    // Função para tratar erro de carregamento de imagem
    function handleImageError(imgElement) {
        console.log('Erro ao carregar imagem do produto, usando imagem padrão');
        
        const defaultImage = imgElement.getAttribute('data-default') || 
                            'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQwDoSndS2IEwkdfPqUMW1AOmu9jPaW94WIbmR37Ffyf7TRnWCuRA94U9bM2eJViBxt3yc&usqp=CAU';
        
        // Substitui a imagem pela padrão
        imgElement.src = defaultImage;
        imgElement.classList.add('default-image');
        imgElement.classList.remove('product-image');
        
        // Remove o evento onerror para evitar loop infinito
        imgElement.onerror = null;
        
        // Adiciona um padding para a imagem padrão ficar melhor
        imgElement.style.padding = '20px';
        imgElement.style.backgroundColor = '#f9f0f2';
    }

    // Otimização de imagens - carregamento inteligente
    document.addEventListener('DOMContentLoaded', function() {
        const productImage = document.getElementById('product-main-image');
        
        if (productImage) {
            // Adiciona um loader enquanto a imagem carrega
            const container = productImage.parentElement;
            const originalBg = container.style.backgroundColor;
            container.style.backgroundColor = '#f5f5f5';
            
            // Quando a imagem carregar, remove o loader
            productImage.onload = function() {
                container.style.backgroundColor = originalBg;
                productImage.style.opacity = '0';
                setTimeout(() => {
                    productImage.style.transition = 'opacity 0.5s ease';
                    productImage.style.opacity = '1';
                }, 10);
            };
            
            // Se já estiver carregada (cache)
            if (productImage.complete) {
                productImage.onload();
            }
        }
        
        // Efeito de zoom sutil ao clicar na imagem (alternativo)
        const imageContainer = document.querySelector('.product-image-container');
        if (imageContainer) {
            const img = imageContainer.querySelector('img');
            if (img) {
                imageContainer.addEventListener('click', function() {
                    img.style.transform = img.style.transform === 'scale(1.05)' ? 'scale(1)' : 'scale(1.05)';
                });
            }
        }
    });
</script>
{% endblock %}